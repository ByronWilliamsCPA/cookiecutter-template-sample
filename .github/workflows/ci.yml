# CI/CD Pipeline with LLM Governance Integration
# Comprehensive code quality, security, and LLM debt detection
#
# Features:
#   - Standard quality checks (tests, linting, type checking)
#   - SonarQube quality gate enforcement
#   - LLM anti-pattern detection
#   - Assumption tag verification
#   - Security scanning
#
# Three-Layer Governance:
#   Layer 1: Production Runtime Risks (RAD tags)
#   Layer 2: LLM Development Debt (LLM tags)
#   Layer 3: Automated Code Quality (SonarQube)
name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, master, develop]
  workflow_dispatch:

# Cancel in-progress runs for same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  PYTHON_VERSION: '3.12'

jobs:
  # ============================================================================
  # Job 1: Standard Quality Checks
  # ============================================================================
  quality-checks:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          uv sync --all-extras

      - name: Run Ruff formatter check
        run: |
          echo "::group::Ruff Formatting"
          uv run ruff format --check src/ tests/ || {
            echo "::error::Code formatting issues detected. Run 'uv run ruff format src/ tests/' to fix."
            exit 1
          }
          echo "::endgroup::"

      - name: Run Ruff linter
        run: |
          echo "::group::Ruff Linting"
          uv run ruff check src/ tests/ --output-format=github
          echo "::endgroup::"

      - name: Run MyPy type checker
        run: |
          echo "::group::MyPy Type Checking"
          uv run mypy src/ --ignore-missing-imports --no-error-summary || {
            echo "::warning::Type checking found issues"
          }
          echo "::endgroup::"

      - name: Run tests with coverage
        run: |
          echo "::group::Test Execution"
          uv run pytest \
            --cov=src \
            --cov-report=xml:coverage.xml \
            --cov-report=term-missing \
            --cov-report=html \
            --cov-branch \
            --cov-fail-under=60 \
            -v
          echo "::endgroup::"

      - name: Security scan with Bandit
        run: |
          echo "::group::Bandit Security Scan"
          uv run bandit -r src/ -f json -o bandit-report.json || {
            echo "::warning::Security issues detected"
            cat bandit-report.json
          }
          echo "::endgroup::"

      - name: Dependency vulnerability scan
        run: |
          echo "::group::Safety Dependency Scan"
          # Export requirements and scan
          uv pip compile pyproject.toml -o requirements.txt
          uv run safety check -r requirements.txt || {
            echo "::warning::Vulnerable dependencies detected"
          }
          echo "::endgroup::"

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            coverage.xml
            htmlcov/
          retention-days: 7

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      # ============================================================================
  # Job 2: LLM Governance Checks
  # ============================================================================
  llm-governance:
    name: LLM Governance & Assumption Verification
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Check for unverified assumption tags
        id: check-tags
        run: |
          echo "::group::Scanning for Unverified Assumption Tags"

          # Check for RAD tags (Layer 1: Production Runtime Risks)
          CRITICAL_TAGS=$(grep -r "#CRITICAL" --include="*.py" src/ 2>/dev/null | wc -l || echo "0")
          ASSUME_TAGS=$(grep -r "#ASSUME" --include="*.py" src/ 2>/dev/null | wc -l || echo "0")
          EDGE_TAGS=$(grep -r "#EDGE" --include="*.py" src/ 2>/dev/null | wc -l || echo "0")

          # Check for LLM debt tags (Layer 2: LLM Development Debt)
          LLM_MOCK=$(grep -r "#LLM-MOCK" --include="*.py" src/ 2>/dev/null | wc -l || echo "0")
          LLM_PLACEHOLDER=$(grep -r "#LLM-PLACEHOLDER" --include="*.py" src/ 2>/dev/null | wc -l || echo "0")
          LLM_LOGIC=$(grep -r "#LLM-LOGIC" --include="*.py" src/ 2>/dev/null | wc -l || echo "0")
          LLM_SCAFFOLD=$(grep -r "#LLM-SCAFFOLD" --include="*.py" src/ 2>/dev/null | wc -l || echo "0")
          LLM_INFERRED=$(grep -r "#LLM-INFERRED" --include="*.py" src/ 2>/dev/null | wc -l || echo "0")
          LLM_TEST_FIRST=$(grep -r "#LLM-TEST-FIRST" --include="*.py" src/ 2>/dev/null | wc -l || echo "0")

          TOTAL_RAD=$((CRITICAL_TAGS + ASSUME_TAGS))
          TOTAL_LLM=$((LLM_MOCK + LLM_PLACEHOLDER + LLM_LOGIC + LLM_SCAFFOLD + LLM_INFERRED + LLM_TEST_FIRST))
          TOTAL_TAGS=$((TOTAL_RAD + TOTAL_LLM))

          echo "rad_tags=$TOTAL_RAD" >> $GITHUB_OUTPUT
          echo "llm_tags=$TOTAL_LLM" >> $GITHUB_OUTPUT
          echo "total_tags=$TOTAL_TAGS" >> $GITHUB_OUTPUT

          echo "### Assumption Tag Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Layer 1 (Production Runtime Risks):**" >> $GITHUB_STEP_SUMMARY
          echo "- #CRITICAL tags: $CRITICAL_TAGS" >> $GITHUB_STEP_SUMMARY
          echo "- #ASSUME tags: $ASSUME_TAGS" >> $GITHUB_STEP_SUMMARY
          echo "- #EDGE tags: $EDGE_TAGS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Layer 2 (LLM Development Debt):**" >> $GITHUB_STEP_SUMMARY
          echo "- #LLM-MOCK: $LLM_MOCK" >> $GITHUB_STEP_SUMMARY
          echo "- #LLM-PLACEHOLDER: $LLM_PLACEHOLDER" >> $GITHUB_STEP_SUMMARY
          echo "- #LLM-LOGIC: $LLM_LOGIC" >> $GITHUB_STEP_SUMMARY
          echo "- #LLM-SCAFFOLD: $LLM_SCAFFOLD" >> $GITHUB_STEP_SUMMARY
          echo "- #LLM-INFERRED: $LLM_INFERRED" >> $GITHUB_STEP_SUMMARY
          echo "- #LLM-TEST-FIRST: $LLM_TEST_FIRST" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total unverified tags: $TOTAL_TAGS**" >> $GITHUB_STEP_SUMMARY

          if [ "$TOTAL_RAD" -gt 0 ]; then
            echo "::error::Found $TOTAL_RAD unverified production risk tags (#CRITICAL, #ASSUME)"
          fi

          if [ "$TOTAL_LLM" -gt 0 ]; then
            echo "::warning::Found $TOTAL_LLM unverified LLM debt tags"
          fi

          echo "::endgroup::"

      - name: Block PR if critical tags found
        if: steps.check-tags.outputs.rad_tags > 0
        run: |
          echo "::error::âŒ PR blocked: Found ${{ steps.check-tags.outputs.rad_tags }} unverified production risk tags"
          echo ""
          echo "Please verify and remove these tags before merging:"
          grep -rn "#CRITICAL\|#ASSUME" --include="*.py" src/ || true
          echo ""
          echo "See CLAUDE.md for verification workflow"
          exit 1

      - name: Detect LLM anti-patterns
        run: |
          echo "::group::LLM Anti-Pattern Detection"

          # Hardcoded localhost/URLs
          echo "Checking for hardcoded localhost/URLs..."
          if grep -rE "(localhost|127\.0\.0\.1|http://|https://)" --include="*.py" src/ | \
             grep -v "#LLM-PLACEHOLDER" | grep -v "^[[:space:]]*#"; then
            echo "::warning::Found hardcoded URLs without #LLM-PLACEHOLDER tag"
          fi

          # Hardcoded secrets patterns
          echo "Checking for potential hardcoded secrets..."
          if grep -rE "(api_key|password|secret|token)\s*=\s*[\"'][^\"']+[\"']" --include="*.py" src/ | \
             grep -v "#LLM-PLACEHOLDER" | grep -v "^[[:space:]]*#"; then
            echo "::error::Potential hardcoded secret detected"
            exit 1
          fi

          # Magic numbers
          echo "Checking for magic numbers..."
          MAGIC_NUMBERS=$(grep -rE "\b[0-9]{2,}\b" --include="*.py" src/ | \
                          grep -v "#LLM-PLACEHOLDER" | \
                          grep -v "^[[:space:]]*#" | \
                          wc -l || echo "0")

          if [ "$MAGIC_NUMBERS" -gt 10 ]; then
            echo "::warning::Found $MAGIC_NUMBERS potential magic numbers without constants"
          fi

          echo "::endgroup::"

  # ============================================================================
  # Summary Job
  # ============================================================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [quality-checks, llm-governance]
    if: always()

    steps:
      - name: Generate final summary
        run: |
          echo "### ðŸš€ CI Pipeline Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All governance layers checked:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code Quality Checks" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… LLM Governance Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status: ${{ job.status }}**" >> $GITHUB_STEP_SUMMARY
